# Discord ポモドーロタイマーボット

Discordのボイスチャンネルでポモドーロテクニックを実践するためのボットです。

## 機能

- 🍅 **ポモドーロタイマー**: 25分の集中時間と5分の休憩時間を4サイクル実行
- 🔇 **チャンネル固有ミュート**: 集中時間中は対象ボイスチャンネルのメンバーのみミュート
- 🔊 **自動アンミュート**: 休憩時間中や他チャンネル移動時にミュートを解除
- ⏸️ **一時停止/再開**: セッション中にタイマーを一時停止・再開可能
- ⏹️ **強制停止**: セッションを途中で停止可能
- 📊 **リアルタイム表示**: 残り時間をリアルタイムで更新表示
- 👥 **スマート参加処理**: セッション中のチャンネル移動を自動で適切に処理
- 🔄 **同時実行**: 複数のボイスチャンネルで同時にセッション実行可能

## インストール

### 1. リポジトリをクローン

```bash
git clone <your-repository-url>
cd pomodoro-discord-bot
```

### 2. 依存関係をインストール

```bash
npm install
```

### 3. Discord Botの作成とセットアップ

#### 3.1 Discord Developer Portalでボットを作成

1. [Discord Developer Portal](https://discord.com/developers/applications) にアクセス
2. 「New Application」をクリックしてアプリケーションを作成
3. アプリケーション名を入力（例：「Pomodoro Timer Bot」）

#### 3.2 ボットトークンを取得

1. 左サイドバーの「Bot」をクリック
2. 「Reset Token」をクリックしてボットトークンを生成
3. トークンをコピーして保存（このトークンは秘密にしてください）

#### 3.3 必要な権限を設定

1. 左サイドバーの「OAuth2」→「URL Generator」をクリック
2. **Scopes**で以下を選択：
   - `bot`
   - `applications.commands`
3. **Bot Permissions**で以下を選択：
   - `Send Messages`
   - `Use Slash Commands`
   - `Connect`
   - `Speak`
   - `Mute Members`
   - `Move Members`

#### 3.4 ボットをサーバーに招待

1. 生成されたURLをコピー
2. URLにアクセスしてボットをDiscordサーバーに招待
3. 適切な権限があることを確認

### 4. 環境変数の設定

`.env.example`を`.env`にコピーして設定：

```bash
cp .env.example .env
```

`.env`ファイルを編集：

```env
DISCORD_TOKEN=あなたのボットトークン
CLIENT_ID=あなたのアプリケーションクライアントID
```

**Client IDの取得方法**：
1. Discord Developer Portalの「General Information」タブ
2. 「Application ID」をコピー

### 5. ボットを起動

```bash
npm start
```

開発環境（自動再起動）：

```bash
npm run dev
```

## デプロイメント

### Google Cloud Run にデプロイ

このボットはGoogle Cloud Runでの実行に最適化されています。

#### クイックデプロイ

```bash
# 自動デプロイスクリプト使用
./deploy.sh YOUR_PROJECT_ID YOUR_DISCORD_TOKEN YOUR_CLIENT_ID

# 手動デプロイ
npm run deploy
```

詳細なデプロイ手順は [DEPLOYMENT.md](DEPLOYMENT.md) を参照してください。

#### デプロイ後の確認

- ヘルスチェック: `https://your-service-url/health`
- ログ確認: Google Cloud Console > Cloud Run > サービス詳細

## 使用方法

### 基本的な使い方

1. ボイスチャンネルに参加
2. `/pomodoro` コマンドを実行
3. ボタンでタイマーを操作

### コマンド

- `/pomodoro [オプション]` - ポモドーロセッションを開始

#### オプション
- `channel` (オプション): 対象のボイスチャンネルを指定
- `focus_time` (オプション): 集中時間を分で指定（1-120分、デフォルト: 25分）
- `break_time` (オプション): 休憩時間を分で指定（1-60分、デフォルト: 5分）
- `cycles` (オプション): サイクル数を指定（1-10回、デフォルト: 4回）

### 使用例

```
# デフォルト設定でセッション開始（25分集中/5分休憩/4サイクル）
/pomodoro

# 特定のボイスチャンネルを指定
/pomodoro channel:#study-room

# カスタム時間設定（30分集中/10分休憩）
/pomodoro focus_time:30 break_time:10

# 短いサイクルで集中（15分集中/3分休憩/6サイクル）
/pomodoro focus_time:15 break_time:3 cycles:6

# 全オプション指定
/pomodoro channel:#work-room focus_time:45 break_time:15 cycles:3
```

### ボタン操作

セッション開始後、以下のボタンでタイマーを操作できます：

- ⏸️ **一時停止** - タイマーを一時停止
- ▶️ **再開** - 一時停止中のタイマーを再開
- ⏹️ **停止** - セッションを強制終了

### ステータス表示

セッション中は以下の情報がリアルタイムで表示されます：

- 現在のフェーズ（集中時間 🍅 / 休憩時間 ☕）
- 現在のサイクル数（例：サイクル 2/4）
- 残り時間（例：23:45）
- タイマーの状態（実行中 ▶️ / 一時停止中 ⏸️）
- 対象のボイスチャンネル名
- カスタム設定された時間（例：集中: 30分 / 休憩: 10分）

## タイマーの動作

### デフォルト設定
- 集中時間: 25分（1-120分でカスタマイズ可能）
- 休憩時間: 5分（1-60分でカスタマイズ可能）
- サイクル数: 4回（1-10回でカスタマイズ可能）

### セッションの流れ
1. 🍅 サイクル1 集中時間 (25分) - 全員ミュート
2. ☕ サイクル1 休憩時間 (5分) - ミュート解除
3. 🍅 サイクル2 集中時間 (25分) - 全員ミュート
4. ☕ サイクル2 休憩時間 (5分) - ミュート解除
5. 🍅 サイクル3 集中時間 (25分) - 全員ミュート
6. ☕ サイクル3 休憩時間 (5分) - ミュート解除
7. 🍅 サイクル4 集中時間 (25分) - 全員ミュート
8. 🎉 セッション完了

## 注意事項とトラブルシューティング

### 必要な権限
- ボットには以下の権限が必要です：
  - `Send Messages` - メッセージ送信
  - `Use Slash Commands` - スラッシュコマンド使用
  - `Connect` - ボイスチャンネル接続
  - `Speak` - ボイスチャンネル発言
  - `Mute Members` - メンバーのミュート（最重要）
  - `Move Members` - メンバーの移動

### 動作仕様
- 1つのボイスチャンネルで同時に実行できるセッションは1つだけです
- **チャンネル固有ミュート**: ミュートは対象チャンネルでのみ適用され、他のチャンネルに移動すると自動的に解除されます
- **スマート移動処理**: セッション中に他チャンネルに移動してから対象チャンネルに戻ると、集中時間中なら再度ミュートされます
- ボットがボイスチャンネルにアクセスできない場合はセッションを開始できません

### よくある問題

#### ボットが反応しない
1. ボットがオンラインになっているか確認
2. 必要な権限が付与されているか確認
3. コンソールのエラーログを確認

#### ミュートが機能しない
1. ボットに「Mute Members」権限があるか確認
2. ボットの役職がユーザーの役職より上位にあるか確認
3. サーバーの権限設定を確認

#### セッションが開始できない
- 対象のボイスチャンネルにメンバーがいるか確認
- 既に同じチャンネルでセッションが実行中でないか確認
- ボットがそのチャンネルにアクセス権限を持っているか確認

## ライセンス

MIT License